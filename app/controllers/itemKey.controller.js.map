{"version":3,"file":"itemKey.controller.js","sourceRoot":"","sources":["itemKey.controller.ts"],"names":[],"mappings":"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","sourcesContent":["import * as mongoose from 'mongoose';\r\nvar ItemKey = require('mongoose').model('ItemKey');\r\nvar Product = require('mongoose').model('Product');\r\nvar Producer = require('mongoose').model('Producer');\r\nimport UuidGenerator = require('../services/uuidGenerator');\r\nclass KeyRequestDataEntry {\r\n    constructor(public data: string, public serial: string) { }\r\n}\r\n\r\nmodule.exports = {\r\n    list: (req, res, next) => {\r\n        ItemKey.find({}).exec((err, itemKeys: Array<Object>) => {\r\n            if (err) {\r\n                return next(err);\r\n            } else {\r\n                res.json(itemKeys.length);\r\n            }\r\n        });\r\n    },\r\n    create: (req, res, next) => {\r\n        var productName = req.body.productName;\r\n        var datas = <KeyRequestDataEntry[]>req.body.datas;\r\n        var commonData = req.body.data;\r\n        var commonSerial = parseInt(req.body.serial);\r\n        var amount = req.body.amount;\r\n        var keysForDatas;\r\n        if (datas && Array.isArray(datas)) {\r\n            keysForDatas = true;\r\n        } else {\r\n\r\n            keysForDatas = false;\r\n        }\r\n\r\n        Product.findOne({ uniqShortProductName: productName }, 'id', (err, product) => {\r\n            if (err) {\r\n                console.log('error in item key find product');\r\n            } else {\r\n                var keysToReturn = [];\r\n                if (keysForDatas) {\r\n                    datas.forEach((d: KeyRequestDataEntry) => {\r\n                        var itemKey: any = new Object();\r\n                        itemKey.product = product.id;\r\n                        itemKey.uuid = UuidGenerator.UuidGenerator.generateId();\r\n                        itemKey.data = d.data;\r\n                        itemKey.serial = d.serial;\r\n                        keysToReturn.push(itemKey);\r\n                    });\r\n\r\n\r\n                } else {\r\n                    if (!commonSerial) {\r\n                        commonSerial = 0;\r\n                    }\r\n                    for (var i = 0; i < amount; i++) {\r\n                        var itemKey: any = new Object();\r\n                        itemKey.product = product.id;\r\n                        itemKey.uuid = UuidGenerator.UuidGenerator.generateId();\r\n                        itemKey.serial = commonSerial++;\r\n                        itemKey.data = commonData;\r\n                        keysToReturn.push(itemKey);\r\n                    }\r\n                }\r\n                ItemKey.collection.insert(keysToReturn, (err, docs) => {\r\n                    if (err) {\r\n                        return next(err);\r\n                    } else {\r\n                        res.json(docs);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n}"]}